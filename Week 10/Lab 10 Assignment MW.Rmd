---
title: "R Notebook"
output: html_notebook
---

# Challenge 1 (4 points)

Create a table with 6 rows and 5 columns. Each row should represent one panther. The first column should represent the panther's ID, and the other 4 columns should represent the estimated 95% home range from the 4 methods we used (MCP, KDE, a-LoCoH, and Brownian bridge). Make sure that all of your units for your home range estimates are the same. Ensure that the final table outputs from the code below.


```{r}
pantherHomeRange <- as.data.frame(matrix(ncol=5, nrow=6))
colnames(pantherHomeRange) <- c("ID", "MCP", "KDE", "a-LoCoh", "Brownian")
pantherHomeRange$ID <- as.factor(c(100, 130, 131, 137, 143, 147))
pantherHomeRange$MCP <- c(148.8854, 864.3615, 217.6840, 264.7383, 608.0366, 1707.8819)*1000
pantherHomeRange$KDE <- c(19543.502, 187306.51, 35964.049, 36770.748, 78699.058, 317707.58)
pantherHomeRange$'a-LoCoh' <- c(6607.962, 52474.690, 13852.141, 12715.252, 10236.601, 38867.576)
pantherHomeRange$Brownian <- c(32044.76, 179704.78, 49305.28, 47091.09, 63329.24, 87800.11)

pantherHomeRange
```

No text necessary.

$\color{red}{\text{Hm, I was expecting you to run the code and pull the values from your fitted models, but I suppose this works. +4}}$



# Challenge 2 (4 points)

Build a boxplot showing the distribution of home range sizes. Your x-axis should have 4 categories (one for each home range type), and your y-axis should show the distribution of the home ranges for the 6 panthers. Which home range estimates tend to be largest? Which ones tend to be smallest? What is your intuitive explanation for why this pattern occurs?

```{r}
require(ggplot2)
require(reshape2)

melt <- reshape2::melt(pantherHomeRange)

ggplot(data=melt, aes(x=variable, y=value)) +
  geom_boxplot() +
  theme_bw()
```

`MCP` tends to be largest because it is just connecting dots, which creates a convex shape and may include a lot of space that isn't actually used. `a-LoCoh` is the smallest. It is building an area from small polygons and adding them up, so it doesn't include excessive convex/unused space. `KDE` and `Brownian` also avoid unused space.

$\color{red}{\text{Good. +4}}$


# Challenge 3 (3 points)

Choose 1 panther and generate a 100% home range based on the MCP. Calculate (and report) the proportion of this polygon comprised of wet and dry forest. Do you think these amounts are representative of the wet and dry forest available to your panther? Why or why not?

```{r}
require(tidyverse)
require(terra)
require(tidyterra)
require(sf)
require(adehabitatHR)
require(adehabitatLT)

land = rast('https://github.com/ValenteJJ/SpatialEcology/raw/main/Week10/panther_landcover.tif')

classification = read.table('https://raw.githubusercontent.com/ValenteJJ/SpatialEcology/main/Week10/landcover%20reclass.txt', header=T) 

land = classify(land, classification[,c(1,3)])
land = categories(land, value=unique(classification[,c(3,4)]))



panthers = st_read('/vsicurl/https://github.com/ValenteJJ/SpatialEcology/raw/main/Week10/panthers.shp') %>% 
  mutate(CatID = as.factor(CatID))

panthersSp = as(panthers, 'Spatial')

mcp100 = mcp(panthersSp[,'CatID'], percent = 100, unin='m', unout='km2')

mcp100Sf = st_as_sf(mcp100)

mcp100Sf.137 <- subset(mcp100Sf, mcp100Sf$id == 137)



habMcp100 = extract(land, mcp100Sf) %>% 
  rename(landcover = Description2) %>% 
  group_by(ID, landcover) %>% 
  summarise(habCells = n()) %>% 
  ungroup() %>% 
  group_by(ID) %>% 
  mutate(totCells = sum(habCells)) %>% 
  ungroup() %>% 
  mutate(propCells = habCells/totCells) %>% 
  pivot_wider(id_cols = ID, names_from = landcover, values_from = propCells, values_fill=0) %>% 
  mutate(ID = mcp100Sf$id) 

habMcp100[habMcp100$ID == 137,]

sum(habMcp100$CypressSwamp[4], habMcp100$HardwoodSwamp[4])
sum(habMcp100$Pineland[4], habMcp100$UplandForest[4])
```

Wet forest: 0.051
Dry forest: 0.146

Because the MCP method is the one most likely to overestimate range size, these proportions might not be very accurate.

$\color{red}{\text{Agreed +3}}$


# Challenge 4 (6 points)

Using the same panther you chose for Challenge 3, generate 10 sf objects, one representing each of the 10%, 20%, 30%, ..., 90%, and 100% home ranges based on a Brownian bridge model. Extract the proportion of each of those territories comprised of dry forest and wet forest. Now generate two line graphs, one for wet forest and one for dry. On the x-axis, plot increasing home range size (10-100%). On the y-axis plot the proportion of the territory comprised of wet/dry forest, and link these with a line. Finally, add a horizontal line that shows the rough proportion of that forest type available to the panther (based on challenge 3). Show your output below.

```{r}
substrRight = function(x, n){
  substr(x, nchar(x) - n+1, nchar(x))
}

panthersSp = panthers %>% 
  mutate(Juldate = as.character(Juldate)) %>% 
  mutate(date = as.numeric(substrRight(Juldate, 3))) %>% 
  mutate(Date = as.Date(date, origin=as.Date("2006-01-01"))) %>% 
  mutate(Date = as.POSIXct(Date, "%Y-%m-%d")) %>% 
  as('Spatial')

pantherLtraj = as.ltraj(xy=coordinates(panthersSp), date=panthersSp$Date, id=panthersSp$CatID, typeII=T)

sigma1 = liker(pantherLtraj, sig2=450, rangesig1=c(2, 100))

bb.137 = kernelbb(pantherLtraj[4], sig=sigma1[[4]]$sig1, sig2=450, grid=500)
plot(bb.137)

bb10Sf = st_as_sf(getverticeshr(bb.137, percent=10))
bb20Sf = st_as_sf(getverticeshr(bb.137, percent=20))
bb30Sf = st_as_sf(getverticeshr(bb.137, percent=30))
bb40Sf = st_as_sf(getverticeshr(bb.137, percent=40))
bb50Sf = st_as_sf(getverticeshr(bb.137, percent=50))
bb60Sf = st_as_sf(getverticeshr(bb.137, percent=60))
bb70Sf = st_as_sf(getverticeshr(bb.137, percent=70))
bb80Sf = st_as_sf(getverticeshr(bb.137, percent=80))
bb90Sf = st_as_sf(getverticeshr(bb.137, percent=90))
bb99Sf = st_as_sf(getverticeshr(bb.137, percent=99)) # 100 gives error

bb.Sf <- rbind(bb10Sf, bb20Sf, bb30Sf, bb40Sf, bb50Sf, bb60Sf, bb70Sf, bb80Sf, bb90Sf, bb99Sf)

bb.Sf$id <- seq(10, 100, 10)

rownames(bb.Sf) <- NULL

bbWetDryProps <- as.data.frame(matrix(NA, nrow=10, ncol=3))
colnames(bbWetDryProps) <- c("Area", "Wet", "Dry")

bbWetDryProps$Area <- c(bb10Sf$area, bb20Sf$area, bb30Sf$area, bb40Sf$area, bb50Sf$area, bb60Sf$area, bb70Sf$area, bb80Sf$area, bb90Sf$area, bb99Sf$area)

hab.bb = extract(land, bb.Sf) %>% 
  rename(landcover = Description2) %>% 
  group_by(ID, landcover) %>% 
  summarise(habCells = n()) %>% 
  ungroup() %>% 
  group_by(ID) %>% 
  mutate(totCells = sum(habCells)) %>% 
  ungroup() %>% 
  mutate(propCells = habCells/totCells) %>% 
  pivot_wider(id_cols = ID, names_from = landcover, values_from = propCells, values_fill=0) %>% 
  mutate(ID = bb.Sf$id) 

hab.bb

bbWetDryProps$Wet <- hab.bb$CypressSwamp+hab.bb$HardwoodSwamp
bbWetDryProps$Dry <- hab.bb$Pineland+hab.bb$UplandForest

bbWetDryProps

ggplot(data=bbWetDryProps) +
  geom_line(aes(x=Area, y=Wet), color='goldenrod') +
  geom_line(aes(x=Area, y=Dry), color='forestgreen') +
  scale_y_continuous(limits=c(0, 0.3)) +
  ylab("Proportion Wet/Dry Forest") +
  theme_bw()

```

No text needed

$\color{red}{\text{Good, but I needed to see the proportions of each cover type available in the MCP home ranges on this plot as well. +5.5}}$


# Challenge 5 (3 points)

Does the panther you chose in Challenge 3/4 prefer dry and/or wet forest? What is your justification for your answer?

When choosing only between forest types, it appears there is a slight preference for dry forest over wet forest. At smaller home range sizes, wet/dry forest makes up a larger proportion of habitat that at larger sizes. However, freshwater marsh habitats make up the largest single proportion at most sizes. Perhaps more time is spent in forest habitat, making it more dominant at small sizes, and activities that require roaming, like hunting or searching for mates, can occur in other habitat types, like marshes.

$\color{red}{\text{Good thinking, but I was hoping to see you compare the finer scale spaces used to what was available at the broader spatial scale. +2}}$
